<html lang="en">
<head>
    <!-- link href='http://fonts.googleapis.com/css?family=Sintony:400,700' rel='stylesheet' type='text/css' -->

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="assets/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

    <script type="text/javascript" language="javascript" src="assets/DataTables/media/js/jquery.js"></script>

    <link href="assets/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="assets/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
    <style type="text/css">
        body {
            padding-top: 60px;
            padding-bottom: 40px;
        }
    </style>
    <link href="css/custom.css" rel="stylesheet">

</head>


<body>
<div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>
            <a class="brand" href="./index.html">Alert Console</a>
            <div class="nav-collapse">
                <ul class="nav">
                    <li class=""><a href="./index.html">Production</a></li>
                    <li class=""><a href="./dev.html">Development</a></li>
                    <li class=""><a href="./infra.html">Infrastructure</a></li>
                    <li class=""><a href="/Kibana">History</a></li>
                    <li class="active"><a href="./about.html">About</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </div>
</div>

<div class="container">
    <div class="row show-grid">
        <div class="span12">
            <div class="row show-grid">
            <table class="table table-bordered table-condensed" id="Heartbeats">
                <thead>
                <tr><th>Origin</th><th>Version</th><th>Heartbeat Sent</th><th>Time Since Received</th><th>Latency</th></tr>
                </thead>
                <tbody id="heartbeat-info">
                <tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                </tbody>
            </table>
            </div> <!-- row -->
        </div> <!-- end span12 -->
    </div> <!-- end row -->
</div> <!-- end container -->

<script>

    var hb_threshold = 300; // 5 minutes

    var api_server = document.domain + ':80';


    function date2str(datetime) {
        var d = new Date(datetime);
        return d.toLocaleString();
    }

    // Update Register Components
    function heartbeatAlerts() {

        $.getJSON('http://' + api_server + '/alerta/management/healthcheck?callback=?', function (data) {

            var hbalerts = '';
            $.each(data.heartbeats, function (i, hb) {

                var diff = (new Date().getTime() - new Date(hb.receiveTime).getTime()) / 1000;
                var mins = Math.floor(diff / 60);
                var secs = Math.floor(diff % 60);

                var since = '';
                if (mins > 0) {
                    since = mins + ' minutes ' + secs + ' seconds';
                } else {
                    since = secs + ' seconds';
                }

                if (diff > hb_threshold) {
                    hbalerts += '<div class="alert alert-error">' +
                            '<button class="close" data-dismiss="alert" onclick="">&times;</button>' +
                            '<strong>Important!</strong> ' + hb.origin + ' has not sent a heartbeat for ' + since +
                            '</div>';
                }
            });
            $('#heartbeat-alerts').html(hbalerts);
        });
    };

    function getHeartbeats(refresh) {

        $.getJSON('http://' + api_server + '/alerta/api/v2/heartbeats?callback=?', function (data) {

            var rows = '';
            $.each(data.heartbeats, function (i, hb) {

                var diff = (new Date().getTime() - new Date(hb.receiveTime).getTime()) / 1000;
                var mins = Math.floor(diff / 60);
                var secs = Math.floor(diff % 60);

                var latency = new Date(hb.receiveTime).getTime() - new Date(hb.createTime).getTime();

                var since = '';
                if (mins > 0) {
                    since = mins + ' minutes ' + secs + ' seconds';
                } else {
                    since = secs + ' seconds';
                }

                rows += '<tr class="">' +
                        '<td>' + hb.origin + '</td>' +
                        '<td>' + hb.version + '</td>' +
                        '<td>' + date2str(hb.createTime) + '</td>' +
                        '<td>' + since + '</td>' +
                        '<td>' + latency + ' ms' + '</td>' +
                        '</tr>';
            });
            $('#heartbeat-info').html(rows);

            if (refresh) {
                timer = setTimeout(function () {
                    getHeartbeats(refresh);
                }, 120000);
            }
        });
    };

    $(document).ready(function() {

        getHeartbeats(true);
    });

</script>

</body>
</html>
