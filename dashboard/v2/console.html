<html lang="en">
<head>
    <!-- link href='http://fonts.googleapis.com/css?family=Sintony:400,700' rel='stylesheet' type='text/css' -->

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="assets/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

    <script type="text/javascript" language="javascript" src="assets/DataTables/media/js/jquery.js"></script>
    <script type="text/javascript" language="javascript" src="assets/DataTables/media/js/jquery.dataTables.min.js"></script>

    <link href="assets/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="assets/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
    <style type="text/css">
        body {
            padding-top: 40px;
            padding-bottom: 40px;
        }
    </style>
    <link href="css/custom.css" rel="stylesheet">

</head>

<body>
<div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>
            <a class="brand" href="./index.html">Alert Console</a>
            <div class="nav-collapse">
                <ul class="nav">
                    <li class="active"><a href="./index.php">Production</a></li>
                    <li class=""><a href="./dev.php">Development</a></li>
                    <li class=""><a href="./infra.php">Infrastructure</a></li>
                    <li class=""><a href="/Kibana">History</a></li>
                    <li class=""><a href="./about.php">About</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </div>
</div>

<div class="container">
    <table width="100%">
        <tr>
            <span id="heartbeat-alerts"></span>
            <div id="console-alert" class="alert alert-info initially-hidden">
                <button class="close" data-dismiss="alert" onclick="">&times;</button>
                <strong>Warning!</strong> <span id="warning-text"></span>
            </div>
        </tr>
        <tr>
            <td>
                <!-- div  id="status-counts" -->
                <table border=1 class="table table-bordered table-condensed"  id="status-counts">
                    <tbody>
                    <tr id="Alert-status" class="status">
                        <td><span class="label">OPEN</span></td>
                        <td id="count-open">0</td>
                        <td><span class="label">ACK</span></td>
                        <td id="count-ack">0</td>
                        <td><span class="label">CLOSED</span></td>
                        <td id="count-closed">0</td>
                    </tr>
                    </tbody>
                </table>
                <!-- /div -->
            </td>
            <td>
                <div align="right">
                    <select id="limit-select" class="btn" name="limit" onchange="updateLimit(this.value)">
                        <option value="0">No limit</option>
                        <option value="10">Only 10</option>
                        <option value="50">Only 50</option>
                        <option value="100">Only 100</option>
                        <option value="500">Only 500</option>
                    </select>
                    <select id="from-date-select" class="btn" name="last" onchange="updateFromDate(this.value)">
                        <option value="0">All alerts</option>
                        <option value="120">Last 2 minutes</option>
                        <option value="300">Last 5 minutes</option>
                        <option value="600">Last 10 minutes</option>
                        <option value="1800">Last 30 minutes</option>
                        <option value="3600">Last 1 hour</option>
                    </select>
                    <button id="refresh-all" class="console-button btn"><i class="icon-refresh"></i> Refresh Now</button>
                </div>
            </td>
        </tr>
    </table>

    <div class="row show-grid">
        <div class="span12">
            <div class="row show-grid">
                <div class="span3">
                    <table class="table table-bordered table-condensed status-indicator" id="R2R1" data-label="R2R1">
                        <thead id="R2R1-overall" class="status-indicator-overall">
                        <tr>
                            <th colspan="6" id="R2R1-status">R2 &amp; R1</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr id="R2R1-status-indicator">
                            <td id="R2R1-critical" class="status-indicator-count">0</td>
                            <td id="R2R1-major" class="status-indicator-count">0</td>
                            <td id="R2R1-minor" class="status-indicator-count">0</td>
                            <td id="R2R1-warning" class="status-indicator-count">0</td>
                            <td id="R2R1-normal" class="status-indicator-count">0</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="span3">
                    <table class="table table-bordered table-condensed status-indicator" id="Frontend" data-label="Frontend">
                        <thead id="Frontend-overall" class="status-indicator-overall">
                        <tr>
                            <th colspan="6" id="Frontend-status">Frontend</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr id="Frontend-status-indicator">
                            <td id="Frontend-critical" class="status-indicator-count">0</td>
                            <td id="Frontend-major" class="status-indicator-count">0</td>
                            <td id="Frontend-minor" class="status-indicator-count">0</td>
                            <td id="Frontend-warning" class="status-indicator-count">0</td>
                            <td id="Frontend-normal" class="status-indicator-count">0</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="span3">
                    <table class="table table-bordered table-condensed status-indicator" id="Discussion" data-label="Discussion">
                        <thead id="Discussion-overall" class="status-indicator-overall">
                        <tr>
                            <th colspan="6" id="Discussion-status">Discussion</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr id="Discussion-status-indicator">
                            <td id="Discussion-critical" class="status-indicator-count">0</td>
                            <td id="Discussion-major" class="status-indicator-count">0</td>
                            <td id="Discussion-minor" class="status-indicator-count">0</td>
                            <td id="Discussion-warning" class="status-indicator-count">0</td>
                            <td id="Discussion-normal" class="status-indicator-count">0</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="span3">
                    <table class="table table-bordered table-condensed status-indicator" id="Other" data-label="Other">
                        <thead id="Other-overall" class="status-indicator-overall">
                        <tr>
                            <th colspan="6" id="Other-status">Other</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr id="Other-status-indicator">
                            <td id="Other-critical" class="status-indicator-count">0</td>
                            <td id="Other-major" class="status-indicator-count">0</td>
                            <td id="Other-minor" class="status-indicator-count">0</td>
                            <td id="Other-warning" class="status-indicator-count">0</td>
                            <td id="Other-normal" class="status-indicator-count">0</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Alert Details -->
    <div class="row show-grid">
        <div class="span12">

            <table cellpadding="0" cellspacing="0" border="0" class="display table table-bordered table-condensed"
                   id="alerts">
                <thead>
                <tr>
                    <th>Severity</th>
                    <th>Status</th>
                    <th>Last Receive Time</th>
                    <th>Dupl. Count</th>
                    <th>Environment</th>
                    <th>Service</th>
                    <th>Resource</th>
                    <th>Event</th>
                    <th>Value</th>
                    <th>Text</th>
                    <th>Severity Code</th>
                </tr>
                </thead>
                <tbody>

                </tbody>
                <tfoot>
                <tr>
                    <th>Severity</th>
                    <th>Status</th>
                    <th>Last Receive Time</th>
                    <th>Dupl. Count</th>
                    <th>Environment</th>
                    <th>Service</th>
                    <th>Resource</th>
                    <th>Event</th>
                    <th>Value</th>
                    <th>Text</th>
                    <th>Severity Code</th>
                </tr>
                </tfoot>
            </table>

        </div>
    </div>
    <!-- end Alert Details -->

</div>
<!-- end container -->

<script>

var logger = 0,
        fromDate = "",
        limit = "",
        timer;

var oTable;
var envfilter = '&environment=PROD|INFRA|DEV'; // used for status count OPEN,ACK,CLOSED
var asiFilter = '&service=shared'; // default, used for displayed alert details
var sevFilter = '';

function fnFormatDetails(aData) {
    var severity = aData[0];
    var status = aData[1];
    var lastReceiveTime = aData[2];
    var duplicateCount = aData[3];
    var environment = aData[4];
    var service = aData[5];
    // TODO(nsatterl): cluster
    var resource = aData[6];
    var event = aData[7];
    var value = aData[8];
    var text = aData[9];
    var severityCode = aData[10];
    var alertid = aData[11];
    var lastReceiveId = aData[12];
    var createTime = aData[13];
    var receiveTime = aData[14];
    var group = aData[15];
    var previousSeverity = aData[16];
    var trendIndication = aData[17];
    var thresholdInfo = aData[18];
    var timeout = aData[19];
    var type = aData[20];
    var repeat = aData[21];
    var summary = aData[22];
    var origin = aData[23];
    var tags = aData[24];
    var moreInfo = aData[25];

    var sOut = '<table class="table table-condensed table-striped">';
    sOut += '<tr class="odd"><td><b>Alert ID</td><td>' + alertid + '</td></tr>';
    sOut += '<tr class="even"><td><b>Last Receive Alert ID</b></td><td>' + lastReceiveId + '</td></tr>';
    sOut += '<tr class="odd"><td><b>Create Time</b></td><td>' + createTime + '</td></tr>';
    sOut += '<tr class="even"><td><b>Receive Time</b></td><td>' + receiveTime + '</td></tr>';
    sOut += '<tr class="odd"><td><b>Last Receive Time</b></td><td>' + lastReceiveTime + '</td></tr>';

    sOut += '<tr class="even"><td><b>Environment</b></td><td>' + environment + '</td></tr>';
    sOut += '<tr class="odd"><td><b>Service</b></td><td>' + service + '</td></tr>';
    sOut += '<tr class="even"><td><b>Resource</b></td><td>' + resource + '</td></tr>';
    sOut += '<tr class="odd"><td><b>Event</b></td><td>' + event + '</td></tr>';
    sOut += '<tr class="even"><td><b>Group</b></td><td>' + group + '</td></tr>';
    sOut += '<tr class="odd"><td><b>Severity</b></td><td>' + previousSeverity + ' -> ' + severity + '</td></tr>';
    sOut += '<tr class="even"><td><b>Status</b></td><td>' + status + '</td></tr>';
    sOut += '<tr class="odd"><td><b>Value</b></td><td>' + value + '</td></tr>';
    sOut += '<tr class="even"><td><b>Text</b></td><td>' + text + '</td></tr>';

    sOut += '<tr class="odd"><td><b>Trend Indication</b></td><td>' + trendIndication + '</td></tr>';
    sOut += '<tr class="even"><td><b>Threshold Info</b></td><td>' + thresholdInfo + '</td></tr>';
    sOut += '<tr class="odd"><td><b>Timeout</b></td><td>' + timeout + '</td></tr>';
    sOut += '<tr class="even"><td><b>Type</b></td><td>' + type + '</td></tr>';
    sOut += '<tr class="odd"><td><b>Repeat</b></td><td>' + repeat + '</td></tr>';
    sOut += '<tr class="even"><td><b>Summary</b></td><td>' + summary + '</td></tr>';
    sOut += '<tr class="odd"><td><b>Origin</b></td><td>' + origin + '</td></tr>';
    sOut += '<tr class="even"><td><b>Tags</b></td><td>' + tags + '</td></tr>';
    // TODO(nsatterl): Graphs
    sOut += '<tr class="odd"><td><b>More Info</b></td><td>' + moreInfo + '</td></tr>';
    sOut += '</table>';

    return sOut;
}

// Alert Status Count for console
function getStatus(statusfilter, refresh) {

    $.getJSON('http://' + document.domain + '/alerta/api/v1/alerts?callback=?&hide-alert-details=true&' + statusfilter + limit + fromDate, function (data) {

        if (data.response.warning) {
            $('#warning-text').text(data.response.warning);
            $('#webapp-alert').toggle();
        }

        $.each(data.response.alerts.statusCounts, function (stat, count) {
            // alert(stat);
            $("#count-" + stat).text(count);
        });
        if (refresh) {
            timer = setTimeout(function () {
                getStatus(statusfilter, refresh);
            }, 120000);
        }
    });
}

function loadStatus(statusfilter, refresh) {
    setTimeout(function () {
        getStatus(statusfilter, refresh);
    }, 0);
}

// Alert Severity Counts for each service
var asiFilters = {
    'R2R1': '&service=R2|R1',
    'Frontend': '&service=Frontend',
    'Discussion': '&service=Discussion',
    'Other': '&-service=R2|R1|Frontend|Discussion'
};

function getAlerts(service, filter, refresh) {

    $('#' + service + ' th').addClass('loader');

    $.getJSON('http://' + document.domain + '/alerta/api/v1/alerts?callback=?&sort-by=lastReceiveTime&' + filter + limit + fromDate, function (data) {

        var sev_id = '#' + service;

        data.response.alerts.severityCounts.normal += data.response.alerts.severityCounts.inform;

        $.each(data.response.alerts.severityCounts, function (sev, count) {
            sev = sev.toLowerCase();
            $(sev_id + "-" + sev).text(count);
            //alert(sev_id + "-" + sev + "=" + count);
            switch (count) {
                case 0:
                    $(sev_id + "-" + sev).removeClass("severity-" + sev).addClass('zero');
                    break;
                default:
                    $(sev_id + "-" + sev).addClass("severity-" + sev).removeClass('zero');
            }
        });

        if (data.response.alerts.severityCounts.critical > 0) {
            scolor = 'red';
        } else if (data.response.alerts.severityCounts.major > 0) {
            scolor = 'orange';
        } else if (data.response.alerts.severityCounts.minor > 0) {
            scolor = 'yellow';
        } else if (data.response.alerts.severityCounts.warning > 0) {
            scolor = 'dodgerblue';
        } else {
            scolor = '#00CC00';
        }
        $(sev_id + "-status").css('background-color', scolor);

        $('#' + service + ' th').removeClass('loader');

        if (refresh) {
            timer = setTimeout(function () {
                getAlerts(service, filter, refresh);
            }, 120000);
        }
    });
};

function loadAlerts(services, refresh) {
    var delayer = 0;
    $.each(services, function (service, filter) {
        setTimeout(function () {
            getAlerts(service, filter, refresh);
        }, delayer);
        delayer += 100;
    });
}

function updateLimit(lim) {
    if (lim > 0) {
        limit = '&limit=' + lim
    } else {
        limit = '';
    }
    $('#refresh-all').trigger('click');
}

function updateFromDate(seconds) {
    if (seconds > 0) {
        fromDate = '&from-date=' + new Date(new Date() - seconds * 1000).toISOString();
    } else {
        fromDate = '';
    }
    $('#refresh-all').trigger('click');
}

$('.status-indicator-overall').click(function () {
    asiFilter = asiFilters[this.id.split('-')[0]];
    sevFilter = '';
    worker();
});

$('.status-indicator-count').click(function () {
    asiFilter = asiFilters[this.id.split('-')[0]];
    sevFilter = '&severity=' + this.id.split('-')[1];
    worker();
});

function worker() {
    $.ajax({
        "dataType": 'json',
        "type": "GET",
        "url": 'http://' + document.domain + '/alerta/api/v1/alerts?callback=?&sort-by=lastReceiveTime'
                + '&environment=PROD|DEV|INFRA'
                + asiFilter + limit + fromDate + sevFilter,
        // "async": false,
        "async": true,
        "success": function (data) {
            $('#alerts').dataTable().fnClearTable();

            $.each(data.response.alerts.alertDetails, function (i, ad) {

                ad.severity = ad.severity.charAt(0).toUpperCase() + ad.severity.slice(1).toLowerCase();
                ad.status = ad.status.charAt(0).toUpperCase() + ad.status.slice(1).toLowerCase();

                var severityCode;
                switch (ad.severity) {
                    case 'Critical':
                        severityCode = 1;
                        break;
                    case 'Major':
                        severityCode = 2;
                        break;
                    case 'Minor':
                        severityCode = 3;
                        break;
                    case 'Warning':
                        severityCode = 4;
                        break;
                    case 'Normal':
                        severityCode = 5;
                        break;
                    case 'Informational':
                        severityCode = 6;
                        break;
                    case 'Debug':
                        severityCode = 7;
                        break;
                    case 'Auth':
                        severityCode = 8;
                        break;
                    default:
                        severityCode = 9; // Unknown
                }

                $('#alerts').dataTable().fnAddData([
                    ad.severity,       // 0
                    ad.status,
                    ad.lastReceiveTime,
                    ad.duplicateCount,
                    ad.environment,
                    ad.service,
                    // TODO(nsatterl): cluster
                    ad.resource,
                    ad.event,
                    ad.value,
                    ad.text,  // 9

                    severityCode, // to enable sorting on severity

                    ad.id, // 11
                    ad.lastReceiveId,
                    ad.createTime,
                    ad.receiveTime,
                    ad.group,
                    ad.previousSeverity,
                    ad.trendIndication,
                    ad.thresholdInfo,
                    ad.timeout,
                    ad.type,
                    ad.repeat,
                    ad.summary,
                    ad.origin,
                    ad.tags,
                    ad.moreInfo
                ]);

            });
        },
        complete: function () {
            oTable.fnDraw(false);
            setTimeout(worker, 30 * 1000); // 30 seconds
        }
    });
};

$(document).ready(function () {

    loadStatus(envfilter, true);
    loadAlerts(asiFilters, true);
    worker();

    $('#refresh-all').click(function() {
        loadStatus(envfilter, false);
        loadAlerts(asiFilters, false);
    });
    var ti;
    // var anOpen = [];
    oTable = $('#alerts').dataTable({
        "bDestroy": true,
        "bUseRendered": false,
        "bSort": true,
        "bPaginate": true,
        "bDeferRender": true,
        "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
            nRow.className = 'severity-' + aData[0] + ' status-' + aData[1];

            if (aData[17] == "noChange") {
                ti = '<i class="icon-minus"></i>&nbsp;'
            } else if (aData[17] == "moreSevere") {
                ti = '<i class="icon-arrow-up"></i>&nbsp;'
            } else if (aData[17] == "lessSevere") {
                ti = '<i class="icon-arrow-down"></i>&nbsp;'
            } else {
                ti = '<i class="icon-random"></i>&nbsp;'
            }
            // Severity = Critical, Major, Minor, Warning, Informational, Debug
            if (aData[0] == "Critical") {
                $('td:eq(0)', nRow).html(ti + '<span class="label label-critical">Critical</span>');
            }
            if (aData[0] == "Major") {
                $('td:eq(0)', nRow).html(ti + '<span class="label label-major">Major</span>');
            }
            if (aData[0] == "Minor") {
                $('td:eq(0)', nRow).html(ti + '<span class="label label-minor">Minor</span>');
            }
            if (aData[0] == "Warning") {
                $('td:eq(0)', nRow).html(ti + '<span class="label label-warning">Warning</span>');
            }
            if (aData[0] == "Normal") {
                $('td:eq(0)', nRow).html(ti + '<span class="label label-success">Normal</span>');
            }
            if (aData[0] == "Informational") {
                $('td:eq(0)', nRow).html(ti + '<span class="label label-success">Inform</span>');
            }
            if (aData[0] == "Debug") {
                $('td:eq(0)', nRow).html(ti + '<span class="label label-inverse">Debug</span>');
            }
            // Status = Open, Acknowledged, Closed
            if (aData[1] == "Open") {
                $('td:eq(1)', nRow).html('<span class="label label-open">Open</span>');
            }
            if (aData[1] == "Acknowledged") {
                $('td:eq(1)', nRow).html('<span class="label label-ack">Acknowledged</span>');
            }
            if (aData[1] == "Closed") {
                $('td:eq(1)', nRow).html('<span class="label label-closed">Closed</span>');
            }
            if (aData[1] == "Expired") {
                $('td:eq(1)', nRow).html('<span class="label label-expired">Expired</span>');
            }
            var d = new Date(aData[2]);
            $('td:eq(2)', nRow).html(d.toLocaleString());

        },
        "aoColumns": [
            { "sWidth": "5%", "iDataSort": 10, "sClass": "align-center" },
            { "sWidth": "5%", "sClass": "align-center" },
            { "sWidth": "10%", "sType": "date", "sClass": "align-center" },
            { "sWidth": "5%", "sClass": "align-center" },
            { "sWidth": "5%", "sClass": "align-center" },
            { "sWidth": "5%", "sClass": "align-center" },
            { "sWidth": "10%", "sClass": "align-center" },
            { "sWidth": "10%", "sClass": "align-center" },
            { "sWidth": "10%", "sClass": "align-center" },
            { "sWidth": "35%" },
            { "bVisible": false }
        ],
        "aaSorting": [
            [2, 'desc']
        ],
        "sDom": "<'row'<'span6'l><'span6'f>r>t<'row'<'span6'i><'span6'p>>"
    });

    $('#alerts tbody tr').live('click', function () {

        var nTr = this;

        // var i = $.inArray( nTr, anOpen );

        if (oTable.fnIsOpen(nTr)) {
            /* This row is already open - close it */
            // this.src = "../examples_support/details_open.png";
            oTable.fnClose(nTr);
        }
        else {
            /* Open this row */
            // this.src = "../examples_support/details_close.png";
            oTable.fnOpen(nTr, fnFormatDetails(oTable.fnGetData(nTr)), 'details');
        }
    });

});
</script>
</body>
</html>
